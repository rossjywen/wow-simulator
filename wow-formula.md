# 1. 魔法技能计算公式

人物面板属性影响法系技能伤害/治疗的属性为

1. 法术强度 spell power

2. 法术急速 spell haste

3. 法术暴击 spell critic

## 1.1 法术强度和coefficient

**法术伤害总体公式**

> $Amount_{法术}= SpellBase+Coefficient\times SpellPower$

`SpellBase` 指的是技能说明中法术的基础伤害

`Coefficient` 对于不同类型的法术有着不同的计算公式 见下面

---

**计算coefficient的特殊规则**

1. 下面使用的==$T_{PanelCastTime}$==指的是技能面板中初始状态显示的施法时间(==受天赋和装备急速影响之前的施法时间==)
2. 直接(不包括引导型)法术施法时间==$T_{PanelCastTime}$大于7秒的按7秒计算==；==小于1.5秒的按1.5秒计算包括瞬发==；

### 1.1.1 直接伤害/治疗 (direct)

**直接法术伤害公式：**

> $Coefficient = T_{PanelCast Time}/ 3.5 $

---

**直接法术治疗量公式:**

> $Coefficient = (T_{PanelCastTime}/ 3.5) \times 1.88$

---

上面这两个公式的意思是对于技能面板上不同的技能来说法术强度使其拥有的收益是不同的，施法时间越长的法术对法术强度的收益越大，大于7秒和小于1.5秒按照`规则1`来计算收益。

举例来说法师的`火焰冲击`

$T_{火焰冲击} = 0$ (瞬发按照1.5计算)

$Coefficient = 1.5 / 3.5 = 42.86\%$

那么火焰冲击（不算任何天赋加成）的伤害就是 

$Amount_{火焰冲击}= (925 – 1095) + SpellPower \times 42.86\%$

*其中"925-1095"是火焰冲击的SpellBase*

### 1.1.2 非直接类伤害/治疗 (dot/hot)

**dot伤害量计算公式:**

> $$Coefficient = T_{DotDuration} \quad / \quad 15$$

---

**hot治疗量计算公式:**

> $$Coefficient = (T_{HotDuration} \quad / \quad 15) \times 1.88$$

---

举例来说牧师的`暗言术:痛`持续时间18s，一共跳6次，那么计算过程如下

$Coefficient_{暗言术:痛}=18/15=120\%$

每次跳伤害的加成

$Coefficient_{tick} = 120\%/6=20\%$

那么`暗言术：痛`每次跳的伤害就是

$Amount_{tick}=1380/6 + 20\% \times SpellPowerc$

*其中1380是技能的SpellBase*

### 1.1.3 引导类伤害/治疗 (channel)

计算公式和直接法术伤害相同，如果计算每一次伤害的量就除以次数即可。(==大于7秒的施法时间正常计算，不会强制锁定到7秒==)

举例法师的`奥术飞弹` 施法时间5s，一共跳5次，那么计算过程如下

$Coefficient_{Total} = 5 / 3.5=142.86\%$

$Coefficient_{Tick} = Coefficient_{Total} / 5= 28.57\%$

### 1.1.4 直接和非直接混合型 (hybrid)

> $x = T_{DotDuration} / 15$
> $y = T_{CastTime} / 3.5$
> $Coefficient_{DoT} = x^2 / (x + y)$
> $Coefficient_{DD} = y^2 / (x + y)$
> $Coefficient_{Total} = Coefficient_{DoT} + Coefficient_{DD}$

---

Example calculation using the Rank 14 (L80) [Moonfire](https://wowwiki-archive.fandom.com/wiki/Moonfire) (Druid) spell:

```
Duration = 12.0 sec
Cast Time = instant (treated as 1.5 sec)

x = 12.0 / 15.0 = 0.8000
y = 1.5 / 3.5 = ~0.4286

CDot = 0.80002 / (0.8000 + 0.4286)
   = 0.6400 / 1.2286
   = 52.09%

CDD = 0.42862 / (0.8000 + 0.4286)
   = 0.1837 / 1.2286
   = 14.95%
```

### 1.1.5 群体技能 (aoe)

aoe技能必然是一个直接的(direct)法术，如牧师的`治疗祷言`；或是一个引导的(channel)法术，如法师的`暴风雪`，绝不存在aoe技能是dot或hot。

无论是哪种aoe，都是按照direct的公式计算的前提下再乘以50%，公式如下。

**伤害法术:**

> $Coefficient = T_{PanelCastTime} / 3.5 \times 50\%$

---

**治疗法术:**

> $Coefficient = (T_{PanelCastTime} / 3.5) \times 1.88 \times 50\%$

---

==从2.4版本引入一项修改使得一旦受到aoe伤害的目标大于一定数量就不会让每一个个体都受到公式中的伤害；而是这些个体分担某一个总和的伤害，这个公式wowwiki没有给出。==

### 1.1.6 带有特殊效果的技能 (effect)

比如寒冰箭这类除了伤害还带有其他效果的技能在法术强度的收益上会乘以一个系数作为penalty，这个系数每个服务器实现的都不一样，可能一些私服和官服的系数是不一样的，Wowwiki给出的系数是95%。

这些特殊效果的技能可能是直接型的也可能是dot型的，总之都是在原有公式计算的基础上再乘以一个系数。

==1. 计算effect必然是前面包括direct dot/hot channel已经计算完之后再乘这个系数==

==2. 目前的技能并不存在hybrid且带有effect的情况，direct带有effect如法师的`寒冰箭`；dot带有effect如德鲁伊的`虫群`。==

### 1.1.7 兼具伤害和治疗的技能 

有一些技能的描述同时带有伤害和治疗的效果，这种技能典型的如
牧师的 `吞噬瘟疫` `神圣新星`
术士的 `吸取生命`
如`吸血鬼拥抱`这类buff造成的治疗不算这类技能

这类技能wiki没有给出绝对的公式，但是这类技能和hybrid技能一样，符合`守恒定律`，所以可以得出下面的公式

> $Coefficient_{Damage} = Coefficient_{Total} \times \frac{伤害量} {伤害量+治疗量}$
> $Coefficient_{Healing} = Coefficient_{Total} \times \frac{治疗量} {伤害量+治疗量}$

---

这类技能没法通过公式计算，但是可以用这个公式来验证测试出的结果。

下面列出wowwiki给出的分配比例，**用计算出的coefficient乘以这个比例就是真正的coefficient**。

| 技能                               | 分配比例     |
| ---------------------------------- | ------------ |
| 吞噬瘟疫(伤害)<br />吞噬瘟疫(治疗) | 75%<br />25% |
| 吸取生命(伤害)<br />吸取生命(治疗) | 50%<br />50% |
| 神圣新星(伤害)<br />神圣新星(治疗) | 50%<br />50% |

==所以这类技能一定是带有fixed标签，并且我在模拟器中的做法是按照伤害和治疗拆分成不同的技能。==

### 1.1.7 一些例外 (fixed)

说明这类技能的实际coefficient不是公式计算得来的，而是固定的猜测可能是固定设计或是被削弱过。

## 1.2 法术暴击

### 1.2.1 计算公式

每种职业80级角色带有恒定的暴击率，如下表。

| Class   | Class Constant |
| ------- | -------------- |
| Druid   | 1.85%          |
| Hunter  | 3.6%           |
| Mage    | 0.91%          |
| Paladin | 3.336%         |
| Priest  | 1.24%          |
| Shaman  | 2.2%           |
| Warlock | 1.701%         |

除了职业自带先天属性之外，影响暴击的属性有2个：`智力`和`暴击等级`，对于80级

1. 每166.6667(也就是$\frac {500} {3}$)的智力值获得百分之1的暴击率提升；
2. 每45.91的暴击等级获得百分之1的暴击率提升，所以80级的计算公式如下。

**计算公式:**

> $Crit Chance = Class Constant + (Intellect / 166.6667) +  (Crit Rating / 45.91)$

---

### 1.2.2 法术暴击bonus

法术暴击的bonus默认是50%的伤害，但是有一些天赋可以改变这个值，典型的就是法师的`碎冰`，这个天赋点满的效果是暴击的bonus翻倍，也就是一旦暴击会提高100%的伤害。

### 1.2.3 其他关于法术暴击的信息

1. 有些天赋的效果是"提高所有法术的法术暴击"(如骑士惩戒系的`定罪`)；有些天赋的效果是"提高某一系法术的法术暴击率"(如法师火焰系的`Critical Mass`)，这类天赋提高的暴击率直接显示在人物面板上。==todo 某一类的也是这样吗？我要验证一下，所以模拟器不能直接输入面板显示的百分比。==
2. 有些天赋的效果是"提高某一个或某几个法术的法术暴击率"(如法师火焰系的`incineration`)，这种天赋提高的暴击率不会在面板上体现出来。
3. 鼠标移动到人物面板上的"智力"所显示出来的log信息对应的就是公式的$ClassConstant+(Intellect/166.667)$ 部分(不包括装备爆击等级造成的提升)。
4. `DK`、`战士`、`盗贼`不会从`智力`属性收益到法术暴击，因而他们也没有职业自带的恒定暴击率。

## 1.3 法术急速

### 1.3.1 计算公式

法术急速不会直接影响伤害值，但是会影响单位时间内的伤害值，对于80级，每32.79的急速等级提高1%的法术急速的公式如下。

> $Spell Haste = (SpellHaste Rating / 32.79)$
>
> $T_{NewCastTime} = T_{OldCastTime} / (1 + Spell Haste)$

---

### 1.3.2 法术急速对GCD的影响

法术急速公式不仅仅对于施法时间对于GCD同样有效果，法系职业初始的GCD是1.5s。

举例对于一个冰法的寒冰箭加完天赋且拥有1000急速等级

**对于寒冰箭**

$T_{OldCastTime}=2.5s$

$Spell Haste = (1000 / 32.79) = 30.497\%$

$T_{NewCastTime} = 2.5 / (1 + 0.305) = 1.91s$

**对于GCD**

$T_{NewGCD}=1.5/(1+0.305)=1.15$

一个深度冻结5s 减去一个GCD等于3.85，大于1.91*2，==这就是为什么PVP法师要达到1000急速的原因，要保证一个深度冻结能打出2根冰箭1根冰枪的效果。==

## 1.4 天赋的影响

**对于法术整体伤害/治疗** (以百分比的形式做乘法)

1. 增加**所有**法术伤害/治疗 (隐藏的，玩家无法直观看到数值只能感受到效果)
2. 增加某一**系**法术伤害/治疗 (隐藏的，玩家无法直观看到数值只能感受到效果)
3. 增加某一**个**法术伤害/治疗 (隐藏的，玩家无法直观看到数值只能感受到效果)
4. 增加某一**个**法术的coefficient (隐藏的，玩家无法直观看到数值只能感受到效果)

**对于法术暴击率** (以百分比的形式做加法)

1. 增加**所有**法术的暴击 (面板上能看到增加)
2. 增加某一**系**法术的暴击 (==据说面板也能看到，需要确认==)
3. 增加某一**个**法术的暴击 (隐藏的，玩家无法直观看到数值只能感受到效果)

**对法术暴击红利** (以百分比的形式做乘法)

1. 增加**所有**法术的暴击红利
2. 增加**某一系**法术的暴击红利

**对于法术急速**

1. 增加**所有**法术的急速百分比 (面板上能看到增加)
2. 减少某一**个**法术的**面板施法时间** (==技能说明上能看到施法时间变化==)

## 1.5 技能属性计算顺序

所有**天赋**和**基础属性**最终都反应在一个技能的**内部属性**上，而这些**内部属性**最终决定了这个技能的所造成的效果的数值。这些属性按照顺序来计算，共分4个阶段如下。

1. 技能的静态数据 
   这部分信息来自没有天赋和属性作用效果时候的技能说明，初始的这部分数据完全是来自游戏的设定信息，所以是完全静态的。
2. 属性
   因为这些值会被天赋使用到，包括`智力`、`精神`、`法术强度` 等。
3. 天赋对技能的影响 
   比如减少技能的施法时间，这个操作一定要在最终在法术急速的作用下计算实际施法时间==之前==就结算，否则就错了。
4. 计算阶段
   在上面的数据确定了之后就可以确定技能的属性了，包括这些属性包括`暴击率`、`实际施法时间`等。

---

**一个技能在不同的阶段确定的属性**

| 阶段         | 技能属性                                                     |
| ------------ | ------------------------------------------------------------ |
| 技能静态数据 | 1. 面板施法时间 (第一次计算)<br />2. coefficient (第一次计算) |
| 属性         | 1. 法术强度 (第一次计算)<br />2. 智力(第一次计算) <br />3. 精神(第一次计算)<br />4. 法术暴击等级 (最终结果)<br />5. 法术急速等级 (最终结果) |
| 天赋         | 1. 法术强度 (第二次计算，最终结果)<br />2. 法术急速(百分比) (第二次计算，最终结果)<br />3. 面板施法时间(第二次计算，最终结果)<br />5. coefficient (第二次计算，最终结果)<br />6. (所有系/某一系/某一个) **技能数值**加成 (==最终结果==)<br />7. (某一系/某一个) **法术暴击率**增加 (==最终结果==)<br />8. (所有系/某一系/某一个) **暴击红利**加成 (==最终结果==) |
| 计算阶段     | 1. 这个法术的伤害加成<br />2. 这个法术的暴击率<br />3. 这个法术的暴击红利<br />4. 这个法术的实际施法时间<br />5. GCD |

---

**法术最终数值加成**

> $Addition_{法术(最终)} = Addition_{所有法术} + Addition_{所在系} + Addition_{这个法术}$

---

**法术最终暴击率**

> $Critical_{法术(最终)} = Class Constant + (Intellect / 166.6667) +  (Crit Rating / 45.91) + Critical_{所有法术增加} + Critical_{法术所属系增加} + Critical_{这个法术增加} $

---

**法术最终暴击红利**

> $CriticalBonus_{法术(最终)}=CriticalBonus_{法术所属系}+CriticalBonus_{这个法术}$

==$CriticalBonus_{所有系}$的初始值是0.5==

---

**法术实际施法时间**

> $T_{ActualCastTime} = T_{ModifiedPanelCastTime} / (1 + SpellHaste)$

---

**GCD**

> $GCD = 1.5 / (1 + SpellHaste)$

---

==模拟器中没有单独记录"所有法术 提高xx"的记录，而是直接加在了所有系上面，这样更方便维护，详见模拟器代码。==

## 1.7 技能数值最终计算

### 1.7.1 直接法术(读条)

**法术非暴击数值计算**

> $Amount_{法术数值(非暴击)min} = (SpellBase_{min} + SpellPower \times Coefficient)\times Addition_{法术(最终)}$
>
> $Amount_{法术数值(非暴击)max} = (SpellBase_{max} + SpellPower \times Coefficient)\times Addition_{法术(最终)}$

---

**法术暴击数值计算**

> $Amount_{法术数值(暴击)min} = Amount_{法术数值(非暴击)min} \times CriticalBonus_{法术(最终)}$
>
> $Amount_{法术数值(暴击)max} = Amount_{法术数值(非暴击)max} \times CriticalBonus_{法术(最终)}$

---

**法术平均数值计算**

> $Average_{min} = Amount_{法术数值(非暴击)min} \times (1 - Critical_{法术(最终)}) + Amount_{法术数值(暴击)min} \times Critical_{法术(最终)}$
>
> $Average_{max} = Amount_{法术数值(非暴击)max} \times (1-Critical_{法术(最终)}) + Amount_{法术数值(暴击)max} \times Critical_{法术(最终)}$

---

**法术单位时间数值计算**

> $DPS_{法术(非暴击)min} = Amount_{法术数值(非暴击)}/T_{ActualCastTime}$
>
> $DPS_{法术(非暴击)max} = Amount_{法术数值(非暴击)}/T_{ActualCastTime}$

---

### 1.7.2 直接法术(引导)

总体和上面相同，区别在于没有min和max，同时引入了tick的概念。

### 1.7.3 时间性法术

> $Amount_{法术数值(总体)} = (SpellBase + SpellPower \times Coefficient)\times Addition_{法术(最终)}$
>
> $Amount_{法术数值(tick)} = Amount_{法术数值(总体)}/N_{tick}$

---

==WOW的设定dot是不能暴击的，但是3.3.5引入了一些天赋使得dot也可以暴击，如果点了这些天赋就可以把暴击应用到dot的计算上。==

> $Amount_{法术数值(总体暴击)} = Amount_{法术数值(总体)} \times CriticalBonus_{法术(最终)}$
>
> $Amount_{法术数值(tick暴击)} = Amount_{法术数值(总体暴击)}/N_{tick}$

---

### 1.7.4 混合型法术

上述两部分都分析











